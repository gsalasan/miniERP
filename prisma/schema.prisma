generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id            String     @id @default(uuid())
  email         String     @unique
  password_hash String
  employee_id   String?    @unique
  is_active     Boolean    @default(true)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  roles         UserRole[] @default([EMPLOYEE])
  employee      employees? @relation(fields: [employee_id], references: [id])
  // Relasi balik ke estimations
  estimations_requested estimations[] @relation("estimations_requested_by")
  estimations_assigned  estimations[] @relation("estimations_assigned_to")
}

model employees {
  id                  String          @id @default(uuid())
  full_name           String
  position            String
  hire_date           DateTime
  basic_salary        Decimal
  allowances          Json
  department          String?
  blood_type          BloodType?
  bank_name           String?
  bank_account_number String?
  npwp                String?
  ptkp                String?
  phone               String?
  tax_id              String?
  gender              Gender?
  marital_status      MaritalStatus?
  employment_type     EmploymentType  @default(FULL_TIME)
  status              EmployeeStatus  @default(ACTIVE)
  education_level     EducationLevel?
  users               users?
}

model Material {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sbu             String?
  system          String?
  subsystem       String?
  item_name       String
  brand           String?
  owner_pn        String?           @map("owner_pn")
  vendor          String?
  status          MaterialStatus?
  location        MaterialLocation?
  cost_ori        Decimal?          @db.Decimal(14, 2)
  curr            String?           @db.VarChar(3)
  satuan          String?           @db.VarChar(50)
  cost_rp         Decimal?          @db.Decimal(14, 2)
  cost_date       DateTime          @default(now()) @db.Timestamptz(6)
  cost_validity   DateTime?         @db.Timestamptz(6)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @db.Timestamptz(6)
  components      Components?
  vendorPricelist VendorPricelist[]
}

model Service {
  id                     String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  service_name           String
  service_code           String                 @unique
  item_type              String                 @default("Service")
  category               String?
  unit                   ServiceUnit
  default_duration       Decimal?               @db.Decimal(10, 2)
  is_active              Boolean                @default(true)
  created_at             DateTime               @default(now()) @db.Timestamptz(6)
  updated_at             DateTime               @default(now()) @db.Timestamptz(6)
  kategori_sistem_id     String?
  sub_sistem_id          String?
  kategori_jasa_id       String?
  jenis_jasa_spesifik_id String?
  deskripsi_id           String?
  rekomendasi_tim_id     String?
  fase_proyek_id         String?
  sbu_id                 String?
  ServiceDescription     ServiceDescription?    @relation(fields: [deskripsi_id], references: [id])
  FaseProyekLookup       FaseProyekLookup?      @relation(fields: [fase_proyek_id], references: [id])
  ServiceSpecificType    ServiceSpecificType?   @relation(fields: [jenis_jasa_spesifik_id], references: [id])
  ServiceCategory        ServiceCategory?       @relation(fields: [kategori_jasa_id], references: [id])
  ServiceSystemCategory  ServiceSystemCategory? @relation(fields: [kategori_sistem_id], references: [id])
  TeamRecommendation     TeamRecommendation?    @relation(fields: [rekomendasi_tim_id], references: [id])
  SBULookup              SBULookup?             @relation(fields: [sbu_id], references: [id])
  ServiceSubSystem       ServiceSubSystem?      @relation(fields: [sub_sistem_id], references: [id])

  @@index([deskripsi_id])
  @@index([fase_proyek_id])
  @@index([jenis_jasa_spesifik_id])
  @@index([kategori_jasa_id])
  @@index([kategori_sistem_id])
  @@index([rekomendasi_tim_id])
  @@index([sbu_id])
  @@index([sub_sistem_id])
}

model hr_employees {
  id                         String                   @id @default(uuid())
  employee_id                String                   @unique
  full_name                  String
  first_name                 String
  last_name                  String
  email                      String                   @unique
  phone                      String?
  personal_email             String?
  gender                     Gender?
  date_of_birth              DateTime?
  place_of_birth             String?
  nationality                String                   @default("Indonesian")
  religion                   String?
  marital_status             MaritalStatus?
  blood_type                 BloodType?
  current_address            String?
  permanent_address          String?
  city                       String?
  province                   String?
  postal_code                String?
  country                    String                   @default("Indonesia")
  emergency_contact_name     String?
  emergency_contact_phone    String?
  emergency_contact_relation String?
  position                   String
  department                 String?
  manager_id                 String?
  employment_type            EmploymentType           @default(FULL_TIME)
  status                     EmployeeStatus           @default(ACTIVE)
  hire_date                  DateTime
  probation_end_date         DateTime?
  confirmation_date          DateTime?
  termination_date           DateTime?
  last_working_date          DateTime?
  basic_salary               Decimal                  @db.Decimal(15, 2)
  allowances                 Json?
  bank_account_number        String?
  bank_name                  String?
  tax_id                     String?
  social_security_id         String?
  work_location              String?
  work_schedule              String?
  working_hours_per_week     Decimal?                 @db.Decimal(5, 2)
  education_level            EducationLevel?
  university                 String?
  major                      String?
  graduation_year            Int?
  gpa                        Decimal?                 @db.Decimal(3, 2)
  certifications             Json?
  skills                     Json?
  languages                  Json?
  profile_picture            String?
  notes                      String?
  is_active                  Boolean                  @default(true)
  created_at                 DateTime                 @default(now())
  updated_at                 DateTime                 @updatedAt
  created_by                 String?
  updated_by                 String?
  attendances                hr_attendances[]
  documents                  hr_employee_documents[]
  manager                    hr_employees?            @relation("EmployeeManager", fields: [manager_id], references: [id])
  subordinates               hr_employees[]           @relation("EmployeeManager")
  leave_requests             hr_leave_requests[]
  performance_reviews        hr_performance_reviews[]
  training_records           hr_training_records[]

  @@map("hr_employees")
}

model hr_attendances {
  id             String           @id @default(uuid())
  employee_id    String
  date           DateTime         @db.Date
  check_in_time  DateTime?
  check_out_time DateTime?
  break_start    DateTime?
  break_end      DateTime?
  status         AttendanceStatus @default(PRESENT)
  total_hours    Decimal?         @db.Decimal(5, 2)
  overtime_hours Decimal?         @db.Decimal(5, 2)
  notes          String?
  location       String?
  ip_address     String?
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  employee       hr_employees     @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@unique([employee_id, date])
  @@map("hr_attendances")
}

model hr_leave_requests {
  id               String       @id @default(uuid())
  employee_id      String
  leave_type       LeaveType
  start_date       DateTime     @db.Date
  end_date         DateTime     @db.Date
  total_days       Int
  reason           String
  status           LeaveStatus  @default(PENDING)
  approved_by      String?
  approved_at      DateTime?
  rejection_reason String?
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
  employee         hr_employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("hr_leave_requests")
}

model hr_performance_reviews {
  id                    String       @id @default(uuid())
  employee_id           String
  review_period         String
  review_year           Int
  review_quarter        Int?
  overall_rating        Decimal      @db.Decimal(3, 2)
  goals_rating          Decimal?     @db.Decimal(3, 2)
  skills_rating         Decimal?     @db.Decimal(3, 2)
  attitude_rating       Decimal?     @db.Decimal(3, 2)
  strengths             String?
  areas_for_improvement String?
  goals_for_next_period String?
  comments              String?
  reviewed_by           String?
  reviewed_at           DateTime?
  created_at            DateTime     @default(now())
  updated_at            DateTime     @updatedAt
  employee              hr_employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("hr_performance_reviews")
}

model hr_training_records {
  id                 String       @id @default(uuid())
  employee_id        String
  training_name      String
  training_provider  String?
  start_date         DateTime     @db.Date
  end_date           DateTime     @db.Date
  duration_hours     Decimal?     @db.Decimal(5, 2)
  certificate_number String?
  certificate_file   String?
  status             String       @default("COMPLETED")
  cost               Decimal?     @db.Decimal(15, 2)
  notes              String?
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt
  employee           hr_employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("hr_training_records")
}

model hr_employee_documents {
  id              String       @id @default(uuid())
  employee_id     String
  document_type   String
  document_name   String
  file_path       String
  file_size       Int?
  mime_type       String?
  is_confidential Boolean      @default(false)
  expiry_date     DateTime?    @db.Date
  uploaded_by     String?
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  employee        hr_employees @relation(fields: [employee_id], references: [id], onDelete: Cascade)

  @@map("hr_employee_documents")
}

model customer_contacts {
  id             String    @id
  customer_id    String
  name           String
  position       String?
  email          String?
  phone          String?
  contact_person String?
  customers      customers @relation(fields: [customer_id], references: [id], onDelete: Cascade)
}

model customers {
  id                String              @id
  customer_name     String
  channel           String
  city              String
  district          String?
  alamat            String?
  status            CustomerStatus
  top_days          Int
  assigned_sales_id String?
  credit_limit      Float?
  no_npwp           String?
  sppkp             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  customer_contacts customer_contacts[]
  customer_rekenings customer_rekenings[]
  projects          projects[]
}

model customer_rekenings {
  id             String    @id @default(uuid())
  customer_id    String
  bank_name      String?
  account_number String
  account_holder String?
  customers      customers @relation(fields: [customer_id], references: [id], onDelete: Cascade)
}

model projects {
  id                 String               @id @default(uuid())
  project_name       String
  project_number     String               @unique
  description        String?
  customer_id        String
  sales_user_id      String?
  status             String               @default("PROSPECT") @db.VarChar(100)
  contract_value     Decimal              @db.Decimal(18, 2)
  estimated_value    Decimal?             @db.Decimal(15, 2)
  estimated_hpp      Decimal?             @db.Decimal(18, 2)
  actual_cost        Decimal?             @db.Decimal(18, 2)
  lead_score         Int?                 @default(0)
  estimation_status  EstimationStatus?    @default(PENDING)
  priority           ProjectPriority      @default(MEDIUM)
  start_date         DateTime?
  expected_close_date DateTime?
  actual_close_date   DateTime?
  notes              String?
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  created_by         String?
  updated_by         String?
  
  estimations        estimations[]
  project_boms       project_boms[]
  project_milestones project_milestones[]
  activities         project_activities[]
  customer           customers            @relation(fields: [customer_id], references: [id])
}

model project_activities {
  id               String          @id @default(uuid())
  project_id       String
  activity_type    ActivityType
  description      String
  performed_by     String
  performed_at     DateTime        @default(now())
  metadata         Json?

  project          projects        @relation(fields: [project_id], references: [id], onDelete: Cascade)
}

model ChartOfAccounts {
  id              Int               @id @default(autoincrement())
  account_code    String            @unique
  account_name    String
  account_type    AccountType
  description     String?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  journal_entries journal_entries[]
}

model exchange_rates {
  id             Int      @id @default(autoincrement())
  currency_from  String   @db.VarChar(3)
  currency_to    String   @db.VarChar(3)
  rate           Decimal  @db.Decimal(18, 6)
  effective_date DateTime @db.Date
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  @@unique([currency_from, currency_to, effective_date])
}

model invoices {
  id               String        @id
  invoice_number   String        @unique
  invoice_date     DateTime      @db.Date
  due_date         DateTime      @db.Date
  customer_id      String?
  customer_name    String
  customer_address String?
  customer_phone   String?
  customer_email   String?
  subtotal         Decimal       @db.Decimal(15, 2)
  tax_amount       Decimal       @default(0) @db.Decimal(15, 2)
  discount_amount  Decimal       @default(0) @db.Decimal(15, 2)
  total_amount     Decimal       @db.Decimal(15, 2)
  currency         String        @default("IDR") @db.VarChar(3)
  status           InvoiceStatus @default(DRAFT)
  notes            String?
  payment_terms    String?
  created_by       String?
  updated_by       String?
  created_at       DateTime      @default(now())
  updated_at       DateTime
}

model tax_rates {
  id          Int      @id @default(autoincrement())
  tax_name    String   @unique
  tax_code    String   @unique
  rate        Decimal  @db.Decimal(5, 2)
  description String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())
}

model vendors {
  id              String               @id @default(uuid())
  vendor_name     String
  category        String?
  classification  VendorClassification
  is_preferred    Boolean              @default(false)
  created_at      DateTime             @default(now())
  updated_at      DateTime             @updatedAt
  vendorPricelist VendorPricelist[]

  @@map("vendors")
}

model VendorCategoryLookup {
  id         String   @id @default(uuid())
  value      String   @unique
  label      String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model VendorClassificationLookup {
  id         String   @id @default(uuid())
  value      String   @unique
  label      String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model VendorPricelist {
  id               String   @id @default(uuid())
  vendor_id        String
  price            Decimal  @db.Decimal(18, 2)
  currency         String   @db.VarChar(3)
  price_updated_at DateTime @default(now()) @db.Timestamptz(6)
  material_id      String   @db.Uuid
  Material         Material @relation(fields: [material_id], references: [id], onDelete: Cascade)
  Vendor           vendors  @relation(fields: [vendor_id], references: [id], onDelete: Cascade)

  @@index([vendor_id])
  @@index([material_id])
  @@map("vendor_pricelist")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model journal_entries {
  id               BigInt          @id @default(autoincrement())
  transaction_date DateTime        @db.Date
  description      String?
  account_id       Int
  debit            Decimal?        @db.Decimal(15, 2)
  credit           Decimal?        @db.Decimal(15, 2)
  reference_id     String?         @db.Uuid
  reference_type   String?         @db.VarChar(50)
  created_by       String?
  created_at       DateTime        @default(now())
  updated_at       DateTime        @default(now())
  ChartOfAccounts  ChartOfAccounts @relation(fields: [account_id], references: [id])

  @@index([account_id])
  @@index([reference_id])
  @@index([transaction_date])
}

model FaseProyekLookup {
  id         String    @id
  name       String    @unique
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  Service    Service[]
}

model SBULookup {
  id         String    @id
  name       String    @unique
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  Service    Service[]
}

model ServiceCategory {
  id                  String                @id
  name                String                @unique
  created_at          DateTime              @default(now()) @db.Timestamptz(6)
  updated_at          DateTime              @default(now()) @db.Timestamptz(6)
  Service             Service[]
  ServiceSpecificType ServiceSpecificType[]
}

model ServiceDescription {
  id         String    @id
  text       String
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  Service    Service[]
}

model ServiceSpecificType {
  id              String          @id
  name            String
  category_id     String
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  updated_at      DateTime        @default(now()) @db.Timestamptz(6)
  Service         Service[]
  ServiceCategory ServiceCategory @relation(fields: [category_id], references: [id])

  @@unique([name, category_id])
  @@index([category_id])
}

model ServiceSubSystem {
  id                    String                @id
  name                  String
  system_category_id    String
  created_at            DateTime              @default(now()) @db.Timestamptz(6)
  updated_at            DateTime              @default(now()) @db.Timestamptz(6)
  Service               Service[]
  ServiceSystemCategory ServiceSystemCategory @relation(fields: [system_category_id], references: [id])

  @@unique([name, system_category_id])
  @@index([system_category_id])
}

model ServiceSystemCategory {
  id               String             @id
  name             String             @unique
  created_at       DateTime           @default(now()) @db.Timestamptz(6)
  updated_at       DateTime           @default(now()) @db.Timestamptz(6)
  Service          Service[]
  ServiceSubSystem ServiceSubSystem[]
}

model TeamRecommendation {
  id         String    @id
  name       String    @unique
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)
  Service    Service[]
}

model estimation_items {
  id                       String      @id
  estimation_id            String
  item_id                  String
  item_type                ItemType
  quantity                 Decimal     @db.Decimal(18, 2)
  source                   SourceType
  hpp_at_estimation        Decimal     @db.Decimal(18, 2)
  sell_price_at_estimation Decimal     @db.Decimal(18, 2)
  estimations              estimations @relation(fields: [estimation_id], references: [id])
}

model estimations {
  id                        String             @id
  project_id                String
  version                   Int
  status                    EstimationStatus
  total_direct_hpp          Decimal            @db.Decimal(18, 2)
  total_overhead_allocation Decimal            @db.Decimal(18, 2)
  total_hpp                 Decimal            @db.Decimal(18, 2)
  total_sell_price          Decimal            @db.Decimal(18, 2)
  // === Estimation Request Extension Fields (Feature 3.1.D) ===
  // Sales user who requested the initial estimation (can be null for legacy rows)
  requested_by_user_id      String?
  // Assigned engineer (Project Engineer) or manager; nullable when unassigned / in general queue
  assigned_to_user_id       String?
  // Technical brief / summary of requirements provided by Sales
  technical_brief           String?
  // Attachment URLs (e.g., drawings, RFQ) stored as JSON array of strings
  attachments               Json?
  // Timestamps
  created_at                DateTime            @default(now()) @db.Timestamptz(6)
  updated_at                DateTime            @updatedAt @db.Timestamptz(6)
  estimation_items          estimation_items[]
  projects                  projects           @relation(fields: [project_id], references: [id])
  // Relasi ke users table
  users_estimations_requested_by_user_idTousers users? @relation("estimations_requested_by", fields: [requested_by_user_id], references: [id])
  users_estimations_assigned_to_user_idTousers  users? @relation("estimations_assigned_to", fields: [assigned_to_user_id], references: [id])

  @@unique([project_id, version])
}

model milestone_templates {
  id            Int     @id @default(autoincrement())
  template_name String  @unique
  project_type  String?
  milestones    Json
}

model project_boms {
  id         String   @id
  project_id String
  item_id    String
  item_type  ItemType
  quantity   Decimal  @db.Decimal(18, 2)
  projects   projects @relation(fields: [project_id], references: [id])
}

model project_milestones {
  id         String          @id
  project_id String
  name       String
  start_date DateTime?
  end_date   DateTime?
  status     MilestoneStatus
  projects   projects        @relation(fields: [project_id], references: [id])
}

enum UserRole {
  CEO
  FINANCE_ADMIN
  SALES
  SALES_MANAGER
  PROJECT_MANAGER
  PROJECT_ENGINEER
  HR_ADMIN
  EMPLOYEE
  PROCUREMENT_ADMIN
  ASSET_ADMIN
  SYSTEM_ADMIN
}

enum MaterialStatus {
  Active
  EndOfLife
  Discontinue
}

enum MaterialLocation {
  Local
  Import
}

enum ServiceUnit {
  Jam
  Hari
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum BloodType {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  FREELANCE
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  TERMINATED
  ON_LEAVE
  PROBATION
}

enum EducationLevel {
  HIGH_SCHOOL
  DIPLOMA
  BACHELOR
  MASTER
  DOCTORATE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  SICK_LEAVE
  VACATION
}

enum LeaveType {
  ANNUAL
  SICK
  MATERNITY
  PATERNITY
  EMERGENCY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  PROSPECT
}

enum AccountType {
  Asset
  Liability
  Equity
  Revenue
  Expense
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum VendorClassification {
  Local
  International
  Principal
  Distributor
  Freelance
}

enum EstimationStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  DRAFT
  ARCHIVED
}

enum ProjectPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  STATUS_CHANGE
  MEETING
  CALL
  EMAIL
  PROPOSAL_SENT
  DOCUMENT_UPLOAD
  NOTE_ADDED
  FOLLOW_UP
}

enum Components {
  Main_Equipment
  Supporting_Equipment
  Installation_Material
  Consumables
}

enum ItemType {
  MATERIAL
  SERVICE
}

enum MilestoneStatus {
  PLANNED
  IN_PROGRESS
  DONE
}

enum SourceType {
  INTERNAL
  EXTERNAL
}
