name: Seed Database

on:
  workflow_dispatch:
    inputs:
      force_seed:
        description: 'Force re-seed even if data exists'
        required: false
        default: false
        type: boolean

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  DATABASE_NAME: minierp
  INSTANCE_NAME: minierp-db

jobs:
  seed-database:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Install Cloud SQL Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          sudo mv cloud-sql-proxy /usr/local/bin/

      - name: Get database password from Secret Manager
        id: get-db-password
        run: |
          # Try to get password from Secret Manager database-secret first
          if gcloud secrets describe database-secret --quiet 2>/dev/null; then
            echo "üìã Found database-secret in Secret Manager, extracting password..."
            DB_URL=$(gcloud secrets versions access latest --secret="database-secret")
            echo "Debug: Connection string format is: ${DB_URL:0:50}..."
            
            # Extract password from connection string: postgresql://postgres:PASSWORD@...
            # Handle both formats:
            # 1. postgresql://postgres:PASSWORD@host/db (localhost format)
            # 2. postgresql://postgres:PASSWORD@/db?host=/cloudsql/... (Cloud SQL socket format)
            PASSWORD=$(echo "$DB_URL" | sed -n 's|.*://postgres:\([^@]*\)@.*|\1|p')
            
            if [ -n "$PASSWORD" ]; then
              echo "‚úÖ Password extracted from Secret Manager"
              echo "password=$PASSWORD" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è  Could not extract password from Secret Manager, using GitHub secret"
              echo "password=${{ secrets.DB_ROOT_PASSWORD }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è  database-secret not found in Secret Manager, using GitHub secret"
            echo "password=${{ secrets.DB_ROOT_PASSWORD }}" >> $GITHUB_OUTPUT
          fi
          
          # For debugging (don't echo the actual password)
          if [ -n "${{ steps.get-db-password.outputs.password }}" ]; then
            echo "‚úÖ Password retrieved successfully (length: $(echo -n '${{ steps.get-db-password.outputs.password }}' | wc -c) characters)"
          else
            echo "‚ùå Warning: Password is empty!"
          fi

      - name: Start Cloud SQL Proxy in background
        run: |
          cloud-sql-proxy ${{ env.PROJECT_ID }}:${{ env.REGION }}:${{ env.INSTANCE_NAME }} --port 5432 &
          PROXY_PID=$!
          echo "Cloud SQL Proxy started with PID: $PROXY_PID"
          echo "Waiting for Cloud SQL Proxy to initialize..."
          
          # Wait for Cloud SQL Proxy to be ready (max 30 seconds)
          # Use timeout or a simple connection test
          for i in {1..30}; do
            # Try to connect using a simple command
            if timeout 2 bash -c "cat < /dev/null > /dev/tcp/127.0.0.1/5432" 2>/dev/null; then
              echo "‚úÖ Cloud SQL Proxy is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "‚ùå Cloud SQL Proxy failed to start after 30 seconds"
              echo "Checking if proxy process is still running..."
              ps aux | grep cloud-sql-proxy | grep -v grep || echo "Proxy process not found"
              exit 1
            fi
            echo "   Waiting... ($i/30)"
            sleep 1
          done

      - name: Install dependencies
        run: |
          npm install
          if [ -f "prisma/schema.prisma" ]; then
            npx prisma generate
          fi

      - name: Create check-seed script
        run: |
          cat > check-seed.mjs << 'EOF'
          import { PrismaClient } from '@prisma/client';
          const prisma = new PrismaClient();
          
          try {
            const taxCount = await prisma.taxRates.count();
            const exchangeCount = await prisma.exchangeRates.count();
            
            if (taxCount > 0 || exchangeCount > 0) {
              console.log('SEEDED=true');
              process.exit(0);
            } else {
              console.log('SEEDED=false');
              process.exit(0);
            }
          } catch (error) {
            console.error('Error checking seed:', error);
            console.log('SEEDED=false');
            process.exit(0);
          } finally {
            await prisma.$disconnect();
          }
          EOF

      - name: Test database connection
        run: |
          echo "üîç Testing database connection..."
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          
          if [ -z "$DB_PASSWORD" ]; then
            echo "‚ùå Error: Database password is empty!"
            echo ""
            echo "Please ensure one of the following:"
            echo "1. The GitHub secret 'DB_ROOT_PASSWORD' is set correctly in your repository"
            echo "2. The Secret Manager secret 'database-secret' exists and contains a valid connection string"
            echo ""
            echo "To set the GitHub secret:"
            echo "1. Go to Settings > Secrets and variables > Actions"
            echo "2. Add or update 'DB_ROOT_PASSWORD' with your Cloud SQL postgres password"
            exit 1
          fi
          
          # URL encode password using Node.js (handles special characters properly)
          export DATABASE_URL=$(node -e "
            const password = encodeURIComponent('$DB_PASSWORD');
            console.log('postgresql://postgres:' + password + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');
          ")
          
          echo "Testing connection with Prisma..."
          node -e "
            import('@prisma/client').then(({ PrismaClient }) => {
              const prisma = new PrismaClient();
              prisma.\$queryRaw\`SELECT version()\`
                .then((result) => {
                  console.log('‚úÖ Database connection successful!');
                  console.log('Database version:', result[0].version.split(' ')[0], result[0].version.split(' ')[1]);
                  return prisma.\$disconnect();
                })
                .catch((err) => {
                  console.error('‚ùå Database connection failed:', err.message);
                  console.error('');
                  console.error('Troubleshooting steps:');
                  console.error('1. Verify DB_ROOT_PASSWORD GitHub secret matches Cloud SQL instance password');
                  console.error('2. Check that Cloud SQL Proxy is running (should be started in previous step)');
                  console.error('3. Ensure the database instance allows connections');
                  console.error('4. Verify the Cloud SQL instance name is: ${{ env.INSTANCE_NAME }}');
                  prisma.\$disconnect();
                  process.exit(1);
                });
            });
          "

      - name: Check if database already seeded
        id: check-seeded
        if: github.event.inputs.force_seed == 'false'
        run: |
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          export DATABASE_URL=$(node -e "console.log('postgresql://postgres:' + encodeURIComponent('$DB_PASSWORD') + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');")
          RESULT=$(node check-seed.mjs 2>&1 | grep "SEEDED=" || echo "SEEDED=false")
          echo $RESULT
          if echo "$RESULT" | grep -q "SEEDED=true"; then
            echo "already_seeded=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Database already contains seed data"
          else
            echo "already_seeded=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Database is empty, will proceed with seeding"
          fi

      - name: Run Prisma migrations
        if: steps.check-seeded.outputs.already_seeded != 'true' || github.event.inputs.force_seed == 'true'
        run: |
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          export DATABASE_URL=$(node -e "console.log('postgresql://postgres:' + encodeURIComponent('$DB_PASSWORD') + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');")
          npx prisma migrate deploy || echo "‚ö†Ô∏è  Note: Migrations may have already been applied"

      - name: Seed database - Users
        if: steps.check-seeded.outputs.already_seeded != 'true' || github.event.inputs.force_seed == 'true'
        run: |
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          export DATABASE_URL=$(node -e "console.log('postgresql://postgres:' + encodeURIComponent('$DB_PASSWORD') + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');")
          echo "üå± Running seed-users.mjs..."
          if [ -f "seed-users.mjs" ]; then
            node seed-users.mjs
          else
            echo "‚ö†Ô∏è  seed-users.mjs not found"
          fi

      - name: Seed database - Tax Rates and Exchange Rates
        if: steps.check-seeded.outputs.already_seeded != 'true' || github.event.inputs.force_seed == 'true'
        run: |
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          export DATABASE_URL=$(node -e "console.log('postgresql://postgres:' + encodeURIComponent('$DB_PASSWORD') + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');")
          echo "üå± Running seed-data.mjs..."
          if [ -f "seed-data.mjs" ]; then
            node seed-data.mjs
          else
            echo "‚ö†Ô∏è  seed-data.mjs not found"
          fi

      - name: Seed database - Journal Entries
        if: steps.check-seeded.outputs.already_seeded != 'true' || github.event.inputs.force_seed == 'true'
        run: |
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          export DATABASE_URL=$(node -e "console.log('postgresql://postgres:' + encodeURIComponent('$DB_PASSWORD') + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');")
          echo "üå± Running seed-journal-entries.mjs..."
          if [ -f "seed-journal-entries.mjs" ]; then
            node seed-journal-entries.mjs
          else
            echo "‚ö†Ô∏è  seed-journal-entries.mjs not found"
          fi

      - name: Seed database - Invoices
        if: steps.check-seeded.outputs.already_seeded != 'true' || github.event.inputs.force_seed == 'true'
        run: |
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          export DATABASE_URL=$(node -e "console.log('postgresql://postgres:' + encodeURIComponent('$DB_PASSWORD') + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');")
          echo "üå± Running seed-invoices.mjs..."
          if [ -f "seed-invoices.mjs" ]; then
            node seed-invoices.mjs
          else
            echo "‚ö†Ô∏è  seed-invoices.mjs not found"
          fi

      - name: Skip seeding message
        if: steps.check-seeded.outputs.already_seeded == 'true' && github.event.inputs.force_seed == 'false'
        run: |
          echo "‚è≠Ô∏è  Skipping seeding - database already contains data"
          echo ""
          echo "üí° To force re-seed, check the 'Force re-seed even if data exists' option"
          echo "   when triggering this workflow manually"

      - name: Verify seeding results
        if: steps.check-seeded.outputs.already_seeded != 'true' || github.event.inputs.force_seed == 'true'
        run: |
          DB_PASSWORD="${{ steps.get-db-password.outputs.password }}"
          export DATABASE_URL=$(node -e "console.log('postgresql://postgres:' + encodeURIComponent('$DB_PASSWORD') + '@127.0.0.1:5432/${{ env.DATABASE_NAME }}');")
          cat > verify-seed.mjs << 'EOF'
          import { PrismaClient } from '@prisma/client';
          const prisma = new PrismaClient();
          
          try {
            const userCount = await prisma.users.count();
            const taxCount = await prisma.taxRates.count();
            const exchangeCount = await prisma.exchangeRates.count();
            const invoiceCount = await prisma.invoices.count();
            const coaCount = await prisma.chartOfAccounts.count();
            
            console.log('‚úÖ Seeding verification:');
            console.log(`   Users: ${userCount}`);
            console.log(`   Tax Rates: ${taxCount}`);
            console.log(`   Exchange Rates: ${exchangeCount}`);
            console.log(`   Invoices: ${invoiceCount}`);
            console.log(`   Chart of Accounts: ${coaCount}`);
          } catch (error) {
            console.error('Error verifying seed:', error);
          } finally {
            await prisma.$disconnect();
          }
          EOF
          node verify-seed.mjs

