name: Deploy miniERP to Railway (GitHub Integration)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  # Test and Build
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix frontend
          npm ci --prefix services/identity-service
          npm ci --prefix services/crm-service
          npm ci --prefix services/finance-service

      - name: Run linting
        run: |
          npm run lint:check || true
          npm run format:check || true

      - name: Run type checking
        run: npm run type-check || true

      - name: Build services
        run: npm run build:services || true

      - name: Build frontend
        run: npm run build:frontend || true

  # Deploy to Railway
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Login to Railway
        run: railway login --token ${{ env.RAILWAY_TOKEN }}

      - name: Deploy Backend Services
        run: |
          echo "üöÄ Deploying backend services..."
          
          # Deploy identity service first (contains database schema)
          railway up --service identity-service --source github &
          
          # Deploy other backend services
          railway up --service crm-service --source github &
          railway up --service finance-service --source github &
          railway up --service hr-service --source github &
          railway up --service engineering-service --source github &
          railway up --service inventory-service --source github &
          railway up --service procurement-service --source github &
          railway up --service project-service --source github &
          
          # Wait for all backend services to deploy
          wait
          
          echo "‚úÖ Backend services deployed"

      - name: Run Database Migrations
        run: |
          echo "üóÑÔ∏è Running database migrations..."
          railway run --service identity-service npx prisma migrate deploy
          railway run --service identity-service npx prisma generate
          echo "‚úÖ Database migrations completed"

      - name: Deploy Frontend Services
        run: |
          echo "üåê Deploying frontend services..."
          
          # Deploy frontend applications
          railway up --service main-frontend --source github &
          railway up --service crm-frontend --source github &
          railway up --service finance-frontend --source github &
          railway up --service hr-frontend --source github &
          railway up --service engineering-frontend --source github &
          railway up --service procurement-frontend --source github &
          railway up --service project-frontend --source github &
          
          # Wait for all frontend services to deploy
          wait
          
          echo "‚úÖ Frontend services deployed"

      - name: Health Check
        run: |
          echo "üîç Performing health checks..."
          
          # Wait a bit for services to start
          sleep 30
          
          # Check service status
          railway status
          
          echo "üéâ Deployment completed successfully!"
          echo ""
          echo "üìä Deployed Services:"
          echo "  ‚Ä¢ Identity Service (Authentication)"
          echo "  ‚Ä¢ CRM Service (Customer Management)"
          echo "  ‚Ä¢ Finance Service (Financial Operations)"
          echo "  ‚Ä¢ HR Service (Human Resources)"
          echo "  ‚Ä¢ Engineering Service (Materials & Services)"
          echo "  ‚Ä¢ Inventory Service (Inventory Management)"
          echo "  ‚Ä¢ Procurement Service (Purchase Orders)"
          echo "  ‚Ä¢ Project Service (Project Management)"
          echo ""
          echo "üåê Frontend Applications:"
          echo "  ‚Ä¢ Main Dashboard"
          echo "  ‚Ä¢ CRM Frontend"
          echo "  ‚Ä¢ Finance Frontend"
          echo "  ‚Ä¢ HR Frontend"
          echo "  ‚Ä¢ Engineering Frontend"
          echo "  ‚Ä¢ Procurement Frontend"
          echo "  ‚Ä¢ Project Frontend"
          echo ""
          echo "üöÄ Your miniERP application is now live on Railway!"

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: failure()
    
    steps:
      - name: Notify Failure
        run: |
          echo "‚ùå Deployment failed!"
          echo "Please check the logs and try again."
          echo "Common issues:"
          echo "  ‚Ä¢ Missing environment variables"
          echo "  ‚Ä¢ Database connection issues"
          echo "  ‚Ä¢ Docker build failures"
          echo "  ‚Ä¢ Service communication problems"
